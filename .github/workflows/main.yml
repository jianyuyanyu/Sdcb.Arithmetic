name: main
on:
  push:
    branches:
      - master
    paths-ignore:
      - '**.md'
      - '**.linq'
  workflow_dispatch:

jobs:
  build-native:
    runs-on: ubuntu-latest
    env:
      GMP_VERSION: 6.3
      GMP_SO_VERSION: 10.5.0
    steps:
      - name: Install dependencies
        run: |
          # Nothing to do
      - name: Download Source
        run: |
          git clone --depth 1 https://github.com/gmp-mirror/gmp-${GMP_VERSION}.git
      - name: autoreconf
        run: |
          cd gmp-${GMP_VERSION}
          autoreconf -ivf
      - name: Configure
        run: |
          cd gmp-${GMP_VERSION}
          ./configure --enable-shared --disable-static --enable-fat CFLAGS="-mavx"
      - name: Build
        run: |
          cd gmp-${GMP_VERSION}
          make MAKEINFO=true
      - name: Check .libs
        run: |
          cd ./gmp-${GMP_VERSION}/.libs
          ls
          file libgmp.so.${GMP_SO_VERSION}
          objdump -d libgmp.so.${GMP_SO_VERSION} | grep -E 'v[a-z]+pd|v[a-z]+ps'
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-x64
          path: libgmp.so.${GMP_SO_VERSION}