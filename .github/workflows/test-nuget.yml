name: Test NuGet

on:
  push:
    branches:
      - master
    paths:
      - .github/workflows/test-nuget.yml
      - src/**
  workflow_dispatch:

env:
  NUGET_REGISTRY: https://proget.starworks.cc:88/nuget/test/v3/index.json
  GMP_NUGET_VERSION: 6.3.0-preview.1
  MPFR_NUGET_VERSION: 4.2.1-preview.2
  
jobs:
  test-gmp:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4
    - name: Configure NuGet Source
      run: nuget sources add -Name StarWorks -Source ${{ env.NUGET_REGISTRY }}
    - name: Ensure NuGet Packages
      run: |
        cd src/Sdcb.Arithmetic.Gmp.Tests
        dotnet add package Sdcb.Arithmetic.Gmp.runtime.win-x64 -v ${{ env.GMP_NUGET_VERSION }} --no-restore
        cat Sdcb.Arithmetic.Gmp.Tests.csproj
    - name: DotNet Restore
      run: |
        cd src/Sdcb.Arithmetic.Gmp.Tests
        dotnet restore
    - name: DotNet Build
      run: |
        cd src/Sdcb.Arithmetic.Gmp.Tests
        dotnet build -c Release --no-restore
    - name: Test
      run: |
        cd src/Sdcb.Arithmetic.Gmp.Tests
        dotnet test -c Release --no-build
  test-mpfr:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4
    - name: Configure NuGet Source
      run: nuget sources add -Name StarWorks -Source ${{ env.NUGET_REGISTRY }}
    - name: Ensure Test NuGet Packages
      run: |
        cd src/Sdcb.Arithmetic.Mpfr.Tests
        dotnet add package Sdcb.Arithmetic.Gmp.runtime.win-x64 -v ${{ env.GMP_NUGET_VERSION }} --no-restore
    - name: DotNet Restore
      run: |
        dotnet restore
    - name: DotNet Build
      run: |
        cd src/Sdcb.Arithmetic.Mpfr.Tests
        dotnet build -c Release --no-restore
    - name: Test
      run: |
        cd src/Sdcb.Arithmetic.Mpfr.Tests
        dotnet test -c Release --no-build